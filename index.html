<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Huechuraba – Identifícate</title>

  <link rel="icon" type="image/png" href="favicon.png.png" />

  <style>
    :root{
      --brand:#0a7cff;
      --brand-strong:#0562d6;
      --text:#1a1a1a;
      --card:#ffffff;
      --muted:#6b7280;
      --radius:14px;
      --shadow:0 18px 40px rgba(2,40,90,.18);
      --ok:#108a00;
      --error:#c0392b;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      color:var(--text);
      background: linear-gradient(135deg,#0a7cff,#00c6ff) fixed;
    }

    /* Franja blanca */
    .hero{
      width:100%;
      background:#fff;
      display:grid;
      place-items:center;
      padding:42px 16px 24px;
      text-align:center;
    }
    .hero .logo{
      width:min(520px, 75vw);
      max-height:160px;
      display:block;
      margin:0 auto 12px auto;
      object-fit:contain;
    }
    .hero .purpose{
      margin:0 0 2px 0;
      font-size:clamp(16px,2.3vw,20px);
      color:#374151;
      font-weight:600;
    }

    /* Sección azul */
    .main{ padding:28px 16px 56px; }
    .wrap{
      max-width:1000px;
      margin:0 auto;
      display:grid;
      gap:22px;
    }

    .header{
      text-align:center;
      color:#fff;
      text-shadow:0 2px 10px rgba(0,0,0,.15);
    }
    .tag{
      display:inline-block;
      margin:0 0 8px 0;
      padding:6px 12px;
      border-radius:999px;
      background:#fff;
      color:var(--brand);
      font-weight:700;
      font-size:clamp(12px,1.9vw,14px);
      box-shadow:0 6px 18px rgba(255,255,255,.25);
    }
    .header h1{
      margin:.25rem 0 0;
      font-size:clamp(22px,3.3vw,34px);
      font-weight:800;
      letter-spacing:.2px;
    }

    /* Bloques de elección */
    .choices{
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap:18px;
    }
    @media (max-width:720px){
      .choices{grid-template-columns:1fr}
    }
    .card{
      background:var(--card);
      border-radius:var(--radius);
      padding:26px;
      display:flex;
      gap:16px;
      align-items:center;
      box-shadow:var(--shadow);
      border:1px solid rgba(255,255,255,.35);
      transition:transform .18s ease, box-shadow .18s ease, background .18s ease;
      cursor:pointer;
    }
    .card:hover{
      transform: translateY(-2px);
      box-shadow:0 22px 48px rgba(2,40,90,.22);
    }
    .badge{
      min-width:48px; min-height:48px; border-radius:12px;
      display:grid; place-items:center; color:#fff; font-weight:700;
      background:linear-gradient(135deg, var(--brand), #22a6ff);
      box-shadow:0 8px 22px rgba(10,124,255,.25);
      font-size:18px;
    }
    .card h3{ margin:0 0 4px 0; font-size:20px }
    .card p{ margin:0; color:var(--muted) }

    .card.active{
      background:#d6e9ff;
      border-color: rgba(10,124,255,.6);
      box-shadow: 0 26px 60px rgba(2,40,90,.35);
      transform: translateY(-3px);
    }
    .card.active .badge{
      background:linear-gradient(135deg, #0349a5, #0562d6);
    }

    /* Formularios */
    .panel{
      margin-top:8px;
      background:#fff;
      border:1px solid rgba(255,255,255,.35);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:26px;
      max-width:520px;
      justify-self:center;
      width:100%;
      display:none;
    }
    .panel.active{ display:block }

    .subtitle{
      margin:0 0 14px 0;
      font-weight:700;
      color:var(--brand-strong);
    }

    .field{ width:100%; margin:10px 0; }
    .input{
      width:100%; padding:12px 14px; font-size:16px;
      border-radius:10px; border:1px solid #e5e7eb;
      outline:0; transition:border .15s ease, box-shadow .15s ease;
    }
    .input:focus{ border-color:var(--brand); box-shadow:0 0 0 4px rgba(10,124,255,.12) }

    .btn{
      width:100%; padding:12px 16px; border:0; border-radius:10px;
      background:linear-gradient(135deg, var(--brand), #1e90ff);
      color:#fff; font-weight:700; letter-spacing:.2px; cursor:pointer;
      transition:filter .15s ease, transform .05s ease;
    }
    .btn:hover{ filter:brightness(1.04) }
    .btn:active{ transform:translateY(1px) }

    .signup{
      text-align:center;
      margin-top:14px;
      font-size:.95rem;
    }
    .signup a{ color:#000; text-decoration:none; font-weight:700; }

    .error{
      margin:10px 0 0;
      color:var(--error);
      font-weight:700;
      text-align:center;
    }
    .ok{
      color:var(--ok);
      font-weight:700;
      text-align:center;
    }

    .hidden{ display:none !important; }

    /* Caja de éxito */
    .success{
      background:#fff;
      border:1px solid rgba(255,255,255,.35);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:26px;
      max-width:720px;
      justify-self:center;
      width:100%;
      text-align:center;
    }
    .success h3{ margin:4px 0 12px 0; }
    .success p{ margin:8px 0 18px 0; }
    .success .ok{ margin:0 0 12px 0; }
  </style>
</head>
<body>

  <!-- FRANJA BLANCA -->
  <section class="hero">
    <img class="logo" src="logo-huechuraba.svg.svg" alt="Municipalidad de Huechuraba" />
    <p class="purpose">Plataforma para <b>levantar solicitudes de Retiro de Escombros</b>.</p>
  </section>

  <!-- SECCIÓN AZUL -->
  <section class="main">
    <div class="wrap">
      <!-- Cabecera azul -->
      <header id="header" class="header">
        <div class="tag">Identifícate para continuar</div>
        <h1>Municipalidad de Huechuraba</h1>
      </header>

      <!-- Bloques de elección -->
      <section id="choices" class="choices">
        <article class="card" id="cardPM">
          <div class="badge">PM</div>
          <div>
            <h3>Personal de la Municipalidad</h3>
            <p>Acceso para funcionarias y funcionarios.</p>
          </div>
        </article>

        <article class="card" id="cardCZ">
          <div class="badge">CZ</div>
          <div>
            <h3>Ciudadanía</h3>
            <p>Vecinas y vecinos para realizar solicitudes.</p>
          </div>
        </article>
      </section>

      <!-- Login -->
      <section id="login" class="panel" aria-live="polite">
        <p class="subtitle" id="roleLabel">Acceso</p>

        <div class="field">
          <input id="loginEmail" class="input" type="email" placeholder="Correo" autocomplete="username" />
        </div>
        <div class="field">
          <input id="loginPass" class="input" type="password" placeholder="Contraseña" autocomplete="current-password" />
        </div>

        <button id="loginBtn" class="btn">Entrar</button>
        <p id="loginError" class="error hidden">Credenciales inválidas</p>

        <p class="signup hidden" id="signupRow">¿No tienes cuenta? <a id="goRegister" href="javascript:void(0)">Regístrate</a></p>
      </section>

      <!-- Registro Ciudadanía -->
      <section id="registerBox" class="panel" aria-live="polite">
        <p class="subtitle">Registro – Ciudadanía</p>

        <div class="field">
          <input id="regNombre" class="input" type="text" placeholder="Nombre completo" />
        </div>
        <div class="field">
          <input id="regCorreo" class="input" type="email" placeholder="Correo" />
        </div>
        <div class="field">
          <input id="regFono" class="input" type="tel" placeholder="Teléfono (formato 569XXXXXXXX)" />
        </div>
        <div class="field">
          <input id="regPass" class="input" type="password" placeholder="Contraseña" />
        </div>

        <button id="regBtn" class="btn">Crear cuenta</button>
        <p id="regMsg" class="error hidden"></p>

        <p class="signup"><a id="goLogin" href="javascript:void(0)">Volver al inicio de sesión</a></p>
      </section>

      <!-- Éxito registro -->
      <section id="successBox" class="success hidden">
        <h3>Registro completado</h3>
        <p class="ok">Tu cuenta fue creada correctamente.</p>
        <button id="backToLogin" class="btn" style="max-width:320px;margin:0 auto;">Volver al inicio de sesión</button>
      </section>
    </div>
  </section>

  <script>
    // ====== Config ======
    const API = 'https://api.proyectosfranco.cl';

    // ====== Elementos ======
    const cardPM = document.getElementById('cardPM');
    const cardCZ = document.getElementById('cardCZ');
    const headerEl = document.getElementById('header');
    const choicesEl = document.getElementById('choices');

    const loginBox = document.getElementById('login');
    const roleLabel = document.getElementById('roleLabel');
    const emailInput = document.getElementById('loginEmail');
    const passInput  = document.getElementById('loginPass');
    const loginBtn   = document.getElementById('loginBtn');
    const loginErr   = document.getElementById('loginError');
    const signupRow  = document.getElementById('signupRow');
    const goRegister = document.getElementById('goRegister');

    const regBox   = document.getElementById('registerBox');
    const regNombre= document.getElementById('regNombre');
    const regCorreo= document.getElementById('regCorreo');
    const regFono  = document.getElementById('regFono');
    const regPass  = document.getElementById('regPass');
    const regBtn   = document.getElementById('regBtn');
    const regMsg   = document.getElementById('regMsg');
    const goLogin  = document.getElementById('goLogin');

    const successBox = document.getElementById('successBox');
    const backToLogin= document.getElementById('backToLogin');

    let currentRole = null; // 'PM' | 'CZ' | null

    // ====== Helpers UI ======
    function hideAllPanels() {
      loginBox.classList.remove('active');
      regBox.classList.remove('active');
      successBox.classList.add('hidden');
    }
    function clearLogin() {
      emailInput.value = '';
      passInput.value  = '';
      loginErr.classList.add('hidden');
    }
    function clearRegister() {
      regNombre.value = '';
      regCorreo.value = '';
      regFono.value   = '';
      regPass.value   = '';
      regMsg.classList.add('hidden');
      regMsg.textContent = '';
    }
    function setCardsActive(role) {
      cardPM.classList.toggle('active', role === 'PM');
      cardCZ.classList.toggle('active', role === 'CZ');
    }

    function resetToStart() {
      currentRole = null;
      setCardsActive(null);
      headerEl.classList.remove('hidden');
      choicesEl.classList.remove('hidden');
      successBox.classList.add('hidden');
      hideAllPanels();
      clearLogin();
      clearRegister();
      // sube cerca del hero
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // ====== Elección de rol ======
    cardPM.addEventListener('click', () => {
      currentRole = 'PM';
      setCardsActive('PM');
      // mostrar login PM
      hideAllPanels();
      clearLogin();
      roleLabel.textContent = 'Acceso – Personal Municipal';
      signupRow.classList.add('hidden');   // PM no se registra aquí
      loginBox.classList.add('active');
      emailInput.focus();
    });

    cardCZ.addEventListener('click', () => {
      currentRole = 'CZ';
      setCardsActive('CZ');
      // mostrar login CZ
      hideAllPanels();
      clearLogin();
      roleLabel.textContent = 'Acceso – Ciudadanía';
      signupRow.classList.remove('hidden'); // CZ puede registrarse
      loginBox.classList.add('active');
      emailInput.focus();
    });

    // ====== Navegación login <-> registro (solo ciudadanía) ======
    goRegister.addEventListener('click', () => {
      if (currentRole !== 'CZ') return;
      hideAllPanels();
      clearRegister();
      regBox.classList.add('active');
      regNombre.focus();
    });
    goLogin.addEventListener('click', () => {
      if (currentRole !== 'CZ') return;
      hideAllPanels();
      clearLogin();
      loginBox.classList.add('active');
      emailInput.focus();
    });

    backToLogin.addEventListener('click', resetToStart);

    // Oculta error al tipear
    [emailInput, passInput].forEach(el =>
      el.addEventListener('input', () => loginErr.classList.add('hidden'))
    );
    [regNombre, regCorreo, regFono, regPass].forEach(el =>
      el.addEventListener('input', () => regMsg.classList.add('hidden'))
    );

    // ====== Login ======
    loginBtn.addEventListener('click', async () => {
      loginErr.classList.add('hidden');

      const correo = emailInput.value.trim();
      const contrasenia = passInput.value;

      if (!currentRole) {
        loginErr.textContent = 'Elige una opción (PM o Ciudadanía) arriba.';
        loginErr.classList.remove('hidden');
        return;
      }
      if (!correo || !contrasenia) {
        loginErr.textContent = 'Completa tu correo y contraseña';
        loginErr.classList.remove('hidden');
        return;
      }

      const url = currentRole === 'PM'
        ? `${API}/auth/login`
        : `${API}/auth/login-ciudadano`;

      try {
        const res = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ correo, contrasenia })
        });
        const data = await res.json();

        if (res.ok && data.ok) {
          // aquí luego rediriges al panel; por ahora limpiamos
          alert('Login correcto');
          resetToStart();
        } else {
          const msg = (data && data.error) ? data.error : 'Credenciales inválidas';
          loginErr.textContent = msg;
          loginErr.classList.remove('hidden');
        }
      } catch {
        loginErr.textContent = 'Error de conexión. Intenta de nuevo.';
        loginErr.classList.remove('hidden');
      }
    });

    // ====== Registro ciudadanía ======
    function fonoValido(v){
      return /^569\d{8}$/.test(v);
    }

    regBtn.addEventListener('click', async () => {
      regMsg.classList.add('hidden');

      const nombre = regNombre.value.trim();
      const correo = regCorreo.value.trim();
      const telefono = regFono.value.trim();
      const contrasenia = regPass.value;

      if (!nombre || !correo || !telefono || !contrasenia){
        regMsg.textContent = 'Completa todos los campos';
        regMsg.classList.remove('hidden');
        return;
      }
      if (!fonoValido(telefono)){
        regMsg.textContent = 'El teléfono debe ser 569XXXXXXXX';
        regMsg.classList.remove('hidden');
        return;
      }

      try {
        const res = await fetch(`${API}/auth/register-ciudadano`,{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ nombre, correo, telefono, contrasenia })
        });
        const data = await res.json();

        if (res.ok && data.ok){
          // Mostrar SOLO la tarjeta de éxito
          headerEl.classList.add('hidden');
          choicesEl.classList.add('hidden');
          hideAllPanels();
          successBox.classList.remove('hidden');
          window.scrollTo({ top: document.querySelector('.main').offsetTop, behavior: 'smooth' });
        }else{
          const msg = (data && data.error) ? data.error : 'No se pudo registrar.';
          regMsg.textContent = msg;
          regMsg.classList.remove('hidden');
        }
      } catch {
        regMsg.textContent = 'Error de conexión. Intenta de nuevo.';
        regMsg.classList.remove('hidden');
      }
    });

    // ====== Estado inicial: nada seleccionado ======
    resetToStart();
  </script>
</body>
</html>

