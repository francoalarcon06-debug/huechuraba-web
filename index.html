<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Huechuraba – Identifícate</title>

  <link rel="icon" type="image/png" href="favicon.png.png" />

  <style>
    :root{
      --brand:#0a7cff;
      --brand-strong:#0562d6;
      --text:#1a1a1a;
      --card:#ffffff;
      --muted:#6b7280;
      --radius:14px;
      --shadow:0 18px 40px rgba(2,40,90,.18);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      color:var(--text);
      background: linear-gradient(135deg,#0a7cff,#00c6ff) fixed;
    }

    /* Franja blanca */
    .hero{
      width:100%;
      background:#fff;
      display:grid;
      place-items:center;
      padding:42px 16px 24px;
      text-align:center;
    }
    .hero .logo{
      width:min(520px, 75vw);
      max-height:160px;
      display:block;
      margin:0 auto 12px auto;
      object-fit:contain;
    }
    .hero .purpose{
      margin:0 0 2px 0;
      font-size:clamp(16px,2.3vw,20px);
      color:#374151;
      font-weight:600;
    }

    /* Sección azul */
    .main{ padding:28px 16px 56px; }

    .wrap{
      max-width:1000px;
      margin:0 auto;
      display:grid;
      gap:22px;
    }

    .header{
      text-align:center;
      color:#fff;
      text-shadow:0 2px 10px rgba(0,0,0,.15);
    }
    .tag{
      display:inline-block;
      margin:0 0 8px 0;
      padding:6px 12px;
      border-radius:999px;
      background:#fff;
      color:var(--brand);
      font-weight:700;
      font-size:clamp(12px,1.9vw,14px);
      box-shadow:0 6px 18px rgba(255,255,255,.25);
    }
    .header h1{
      margin:.25rem 0 0;
      font-size:clamp(22px,3.3vw,34px);
      font-weight:800;
      letter-spacing:.2px;
    }

    /* Bloques de elección */
    .choices{
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap:18px;
    }
    @media (max-width:720px){
      .choices{grid-template-columns:1fr}
    }
    .card{
      background:var(--card);
      border-radius:var(--radius);
      padding:26px;
      display:flex;
      gap:16px;
      align-items:center;
      box-shadow:var(--shadow);
      border:1px solid rgba(255,255,255,.35);
      transition:transform .18s ease, box-shadow .18s ease, background .18s ease;
      cursor:pointer;
    }
    .card:hover{
      transform: translateY(-2px);
      box-shadow:0 22px 48px rgba(2,40,90,.22);
    }

    .badge{
      min-width:48px; min-height:48px; border-radius:12px;
      display:grid; place-items:center; color:#fff; font-weight:700;
      background:linear-gradient(135deg, var(--brand), #22a6ff);
      box-shadow:0 8px 22px rgba(10,124,255,.25);
      font-size:18px;
    }
    .card h3{ margin:0 0 4px 0; font-size:20px }
    .card p{ margin:0; color:var(--muted) }

    .card.active{
      background:#d6e9ff;
      border-color: rgba(10,124,255,.6);
      box-shadow: 0 26px 60px rgba(2,40,90,.35);
      transform: translateY(-3px);
    }
    .card.active .badge{
      background:linear-gradient(135deg, #0349a5, #0562d6);
    }

    /* Formulario base (login/registro comparten panel) */
    .panel{
      margin-top:8px;
      background:#fff;
      border:1px solid rgba(255,255,255,.35);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:26px;
      max-width:520px;
      justify-self:center;
      width:100%;
      display:none;
    }
    .panel.active{ display:block }

    .subtitle{
      margin:0 0 14px 0;
      font-weight:700;
      color:var(--brand-strong);
    }

    .field{ width:100%; margin:10px 0; }
    .input{
      width:100%; padding:12px 14px; font-size:16px;
      border-radius:10px; border:1px solid #e5e7eb;
      outline:0; transition:border .15s ease, box-shadow .15s ease;
    }
    .input:focus{ border-color:var(--brand); box-shadow:0 0 0 4px rgba(10,124,255,.12) }

    .btn{
      width:100%; padding:12px 16px; border:0; border-radius:10px;
      background:linear-gradient(135deg, var(--brand), #1e90ff);
      color:#fff; font-weight:700; letter-spacing:.2px; cursor:pointer;
      transition:filter .15s ease, transform .05s ease;
    }
    .btn:hover{ filter:brightness(1.04) }
    .btn:active{ transform:translateY(1px) }

    .signup{
      text-align:center;
      margin-top:14px;
      font-size:.95rem;
    }
    .signup a{
      color:#000;
      text-decoration:none;
      font-weight:700;
      cursor:pointer;
    }
    .hidden{ display:none }
    .error{
      margin:10px 0 0;
      color:#c0392b;
      font-weight:700;
      text-align:center;
    }
    .ok{
      margin:10px 0 0;
      color:#065f46;
      font-weight:700;
      text-align:center;
    }
    .muted{ color:#6b7280; font-size:.95rem; }
  </style>
</head>
<body>

  <!-- FRANJA BLANCA -->
  <section class="hero">
    <img class="logo" src="logo-huechuraba.svg.svg" alt="Municipalidad de Huechuraba" />
    <p class="purpose">Plataforma para <b>levantar solicitudes de Retiro de Escombros</b>.</p>
  </section>

  <!-- SECCIÓN AZUL -->
  <section class="main">
    <div class="wrap">
      <header class="header">
        <div class="tag">Identifícate para continuar</div>
        <h1>Municipalidad de Huechuraba</h1>
      </header>

      <!-- Bloques -->
      <section class="choices">
        <article class="card" id="cardPM" onclick="chooseRole('Personal Municipal')">
          <div class="badge">PM</div>
          <div>
            <h3>Personal de la Municipalidad</h3>
            <p>Acceso para funcionarias y funcionarios.</p>
          </div>
        </article>

        <article class="card" id="cardCZ" onclick="chooseRole('Ciudadanía')">
          <div class="badge">CZ</div>
          <div>
            <h3>Ciudadanía</h3>
            <p>Vecinas y vecinos para realizar solicitudes.</p>
          </div>
        </article>
      </section>

      <!-- Login -->
      <section id="login" class="panel" aria-live="polite">
        <p class="subtitle" id="roleLabel">Acceso</p>

        <div class="field">
          <input id="loginEmail" class="input" type="email" placeholder="Correo" required />
        </div>
        <div class="field">
          <input id="loginPass" class="input" type="password" placeholder="Contraseña" required />
        </div>

        <button id="loginBtn" class="btn">Entrar</button>
        <p id="loginError" class="error hidden">Credenciales inválidas</p>

        <p class="signup hidden" id="signupRow">¿No tienes cuenta? <a id="openRegister">Regístrate</a></p>
      </section>

      <!-- Registro ciudadanía -->
      <section id="register" class="panel" aria-live="polite">
        <p class="subtitle">Registro – Ciudadanía</p>

        <div class="field">
          <input id="rNombre" class="input" type="text" placeholder="Nombre completo" required />
        </div>
        <div class="field">
          <input id="rCorreo" class="input" type="email" placeholder="Correo" required />
        </div>
        <div class="field">
          <input id="rTelefono" class="input" type="text" placeholder="Teléfono (formato 569XXXXXXXX)" maxlength="11" />
        </div>
        <div class="field">
          <input id="rPass" class="input" type="password" placeholder="Contraseña" required />
        </div>

        <button id="registerBtn" class="btn">Crear cuenta</button>
        <p id="registerMsg" class="ok hidden"></p>
        <p class="signup"><a id="backToLogin">Volver al inicio de sesión</a></p>
      </section>
    </div>
  </section>

  <script>
    // API base
    const API = 'https://api.proyectosfranco.cl';

    // Estado actual del rol (null hasta que elija)
    let currentRole = null;

    // Elementos comunes
    const loginBox   = document.getElementById('login');
    const roleLabel  = document.getElementById('roleLabel');
    const emailInput = document.getElementById('loginEmail');
    const passInput  = document.getElementById('loginPass');
    const errorBox   = document.getElementById('loginError');
    const signupRow  = document.getElementById('signupRow');
    const btnLogin   = document.getElementById('loginBtn');

    // Registro
    const panelRegister = document.getElementById('register');
    const openRegister  = document.getElementById('openRegister');
    const backToLogin   = document.getElementById('backToLogin');
    const rNombre       = document.getElementById('rNombre');
    const rCorreo       = document.getElementById('rCorreo');
    const rTelefono     = document.getElementById('rTelefono');
    const rPass         = document.getElementById('rPass');
    const btnRegister   = document.getElementById('registerBtn');
    const registerMsg   = document.getElementById('registerMsg');

    // Oculta error al empezar a escribir
    [emailInput, passInput].forEach(el => {
      el.addEventListener('input', () => errorBox.classList.add('hidden'));
    });

    function clearLogin(){
      emailInput.value = '';
      passInput.value = '';
      errorBox.classList.add('hidden');
      errorBox.textContent = 'Credenciales inválidas';
    }
    function clearRegister(){
      rNombre.value = '';
      rCorreo.value = '';
      rTelefono.value = '';
      rPass.value = '';
      registerMsg.className = 'ok hidden';
      registerMsg.textContent = '';
    }

    function chooseRole(role){
      // Activar tarjeta
      document.getElementById('cardPM').classList.toggle('active', role === 'Personal Municipal');
      document.getElementById('cardCZ').classList.toggle('active', role === 'Ciudadanía');

      // Mostrar panel de login
      loginBox.classList.add('active');
      panelRegister.classList.remove('active');

      // Título y estado
      roleLabel.textContent = 'Acceso – ' + role;
      currentRole = role;

      // Limpiar campos y mensajes
      clearLogin();

      // Mostrar/ocultar registro
      if (role === 'Personal Municipal') {
        signupRow.classList.add('hidden');
      } else {
        signupRow.classList.remove('hidden');
      }

      // Focus
      emailInput.focus();
    }

    // LOGIN
    btnLogin.addEventListener('click', async () => {
      errorBox.classList.add('hidden');

      const correo = emailInput.value.trim();
      const contrasenia = passInput.value;

      if (!correo || !contrasenia) {
        errorBox.textContent = 'Completa tu correo y contraseña';
        errorBox.classList.remove('hidden');
        return;
      }
      if (!currentRole){
        errorBox.textContent = 'Elige un tipo de acceso.';
        errorBox.classList.remove('hidden');
        return;
      }

      // Endpoint según rol
      const endpoint = (currentRole === 'Ciudadanía')
        ? `${API}/citizens/login`
        : `${API}/auth/login`;

      try {
        btnLogin.disabled = true;
        btnLogin.textContent = 'Verificando...';

        const res = await fetch(endpoint, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ correo, contrasenia })
        });

        const data = await res.json().catch(()=> ({}));

        if (res.ok && data.ok) {
          // Aquí luego redirigimos a la app/panel. Por ahora muestro verify.html a modo demo.
          location.href = 'verify.html';
        } else {
          errorBox.textContent = data && data.error ? data.error : 'Credenciales inválidas';
          errorBox.classList.remove('hidden');
        }
      } catch (e) {
        errorBox.textContent = 'Error de conexión. Intenta de nuevo.';
        errorBox.classList.remove('hidden');
      } finally {
        btnLogin.disabled = false;
        btnLogin.textContent = 'Entrar';
      }
    });

    // Abrir/cerrar registro
    openRegister?.addEventListener('click', (e)=>{
      e.preventDefault();
      clearRegister();
      loginBox.classList.remove('active');
      panelRegister.classList.add('active');
      rNombre.focus();
    });
    backToLogin?.addEventListener('click', (e)=>{
      e.preventDefault();
      clearLogin();
      panelRegister.classList.remove('active');
      loginBox.classList.add('active');
      emailInput.focus();
    });

    // REGISTRO ciudadanía
    btnRegister.addEventListener('click', async ()=>{
      registerMsg.className = 'ok hidden';
      registerMsg.textContent = '';

      const nombre = rNombre.value.trim();
      const correo = rCorreo.value.trim();
      const telefono = rTelefono.value.trim();
      const contrasenia = rPass.value;

      // Valida teléfono 569XXXXXXXX
      if (telefono && !/^569\d{8}$/.test(telefono)) {
        registerMsg.className = 'error';
        registerMsg.textContent = 'El teléfono debe ser 569XXXXXXXX (11 dígitos).';
        registerMsg.classList.remove('hidden');
        return;
      }
      if (!nombre || !correo || !contrasenia){
        registerMsg.className = 'error';
        registerMsg.textContent = 'Completa nombre, correo y contraseña.';
        registerMsg.classList.remove('hidden');
        return;
      }

      try{
        btnRegister.disabled = true;
        btnRegister.textContent = 'Creando...';

        const res = await fetch(`${API}/citizens/register`, {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({ nombre, correo, telefono, contrasenia })
        });
        const data = await res.json().catch(()=> ({}));

        if (!res.ok || !data.ok){
          registerMsg.className = 'error';
          registerMsg.textContent = (data && data.error) ? data.error : 'No se pudo registrar.';
          registerMsg.classList.remove('hidden');
          return;
        }

        const link = data.verifyLink || '';
        registerMsg.className = 'ok';
        registerMsg.innerHTML = `
          Registro creado. Te enviamos un correo para verificar.<br/>
          <span class="muted">Para pruebas:</span> ${link ? `<a href="${link}">Verificar ahora</a>` : '(sin enlace de prueba)'}
        `;
        registerMsg.classList.remove('hidden');
        clearRegister();
      } catch(e){
        registerMsg.className = 'error';
        registerMsg.textContent = 'Error de red. Intenta de nuevo.';
        registerMsg.classList.remove('hidden');
      } finally {
        btnRegister.disabled = false;
        btnRegister.textContent = 'Crear cuenta';
      }
    });
  </script>
</body>
</html>
