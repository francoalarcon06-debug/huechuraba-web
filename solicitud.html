<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Huechuraba – Realizar solicitud</title>
  <link rel="icon" type="image/png" href="favicon.png.png" />
  <style>
    :root{
      --white:#ffffff;
      --blue:#0b6ef3;
      --blue-dark:#0a54c9;
      --text:#0b1220;
      --muted:#475569;
      --outline:#1e40af;
      --shadow:0 8px 28px rgba(2,6,23,.10);
      --card:#f6f9ff;
      --danger:#b91c1c;
      --ok:#065f46;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui,-apple-system,"Segoe UI",Roboto,Arial,"Helvetica Neue",Helvetica,sans-serif;
      color:var(--text);
      display:flex; flex-direction:column;
      background: linear-gradient(180deg, #eaf2ff 0%, #eaf2ff 44%, #cfe3ff 45%, #b9d6ff 100%);
    }

    /* HEADER */
    header{ background:#fff; border-bottom:1px solid #e6eefc; }
    .wrap{
      max-width:1120px; margin:0 auto; padding:18px 20px;
      display:grid; grid-template-columns: 1fr auto; align-items:center; gap:18px;
    }
    .brand{ display:grid; grid-template-columns:auto 1fr; align-items:center; column-gap:16px; }
    .brand img{ height:78px; width:auto; object-fit:contain; }
    .brand .subtitle{ grid-column: 1 / -1; margin:6px 0 0 0; color:var(--muted); font-size:15px; font-weight:600; }
    .userbox{ position:relative; }
    .userbtn{
      display:flex; align-items:center; gap:10px; background:#fff;
      border:2px solid var(--outline); padding:10px 14px; border-radius:12px;
      cursor:pointer; font-weight:700; color:var(--outline); box-shadow: var(--shadow);
    }
    .userbtn img{ width:22px; height:22px; object-fit:contain; }
    .chev{ font-size:13px; }
    .dropdown{
      position:absolute; right:0; top:calc(100% + 8px); background:#fff;
      border:1px solid #dbe4ff; border-radius:12px; box-shadow: var(--shadow);
      overflow:hidden; min-width:260px; display:none;
    }
    .dropdown.open{ display:block; }
    .dropdown .head{
      padding:12px 14px; font-size:14px; color:#0b3a88; background:#f8fbff;
      border-bottom:1px solid #e6eefc; font-weight:700; word-break:break-all;
    }
    .dropdown button{
      all:unset; display:block; width:100%; padding:12px 14px; cursor:pointer;
      font-weight:700; color:#b91c1c;
    }
    .dropdown button:hover{ background:#fee2e2; }

    /* CUERPO AZUL */
    main{
      flex:1; background: linear-gradient(180deg, var(--blue) 0%, var(--blue-dark) 100%);
      padding:26px 16px 70px;
    }

    /* Formulario */
    form{ max-width:1024px; margin:0 auto; padding:0 8px; }
    .form-grid{
      background:#0b6ef3;
      padding:26px 20px 28px;
      border-radius:14px;
      box-shadow:0 16px 40px rgba(0,0,0,.12) inset, 0 12px 28px rgba(0,0,0,.10);
    }
    .row{ margin-bottom:18px; }
    label{ display:block; color:#fff; font-weight:700; margin-bottom:8px; }
    .input, .select, .textarea{
      width:100%; padding:14px 12px; border-radius:10px; border:1px solid #e6eefc;
      outline:0; font-size:16px; background:#fff;
    }
    .input:focus, .select:focus, .textarea:focus{
      border-color:#2b7bff; box-shadow:0 0 0 4px rgba(43,123,255,.18);
    }
    .cols{ display:grid; grid-template-columns:1fr 1fr; gap:20px; }
    @media (max-width:820px){ .cols{ grid-template-columns:1fr; } }

    .checks{ display:flex; gap:24px; flex-wrap:wrap; }
    .checks label{ color:#fff; font-weight:700; margin:0; display:flex; align-items:center; gap:10px; }
    .hint{ color:#e0eaff; font-size:12px; margin-top:6px; }
    .counter{ color:#e0eaff; font-size:12px; text-align:right; margin-top:6px; }

    .actions{ display:flex; gap:12px; justify-content:flex-end; margin-top:24px; }
    .btn{
      padding:12px 18px; border-radius:10px; border:0; font-weight:800; cursor:pointer;
      box-shadow:0 8px 22px rgba(0,0,0,.12);
    }
    .btn-cancel{ background:#ffffff; color:#0b3a88; border:2px solid #0b3a88; }
    .btn-ok{ background:#1e90ff; color:#fff; }
    .error{ color:#ffe3e3; background:#7f1d1d; border:1px solid #fecaca; padding:8px 10px; border-radius:8px; display:none; }
    .error.show{ display:block; }

    .file-note{ color:#e0eaff; font-size:12px; margin-left:6px; }
  </style>
</head>
<body>

  <!-- HEADER -->
  <header>
    <div class="wrap">
      <div class="brand">
        <img src="logo-huechuraba.svg.svg" alt="Huechuraba – Puede más" />
        <div></div>
        <p class="subtitle">Plataforma para <strong>levantar solicitudes de Retiro de Escombros.</strong></p>
      </div>

      <div class="userbox">
        <button class="userbtn" id="userBtn" aria-haspopup="true" aria-expanded="false">
          <img src="cuenta.png" alt="Cuenta" />
          <span>Mi sesión</span>
          <span class="chev" aria-hidden="true">▾</span>
        </button>

        <div class="dropdown" id="userMenu" role="menu">
          <div class="head" id="emailFull">—</div>
          <button type="button" onclick="logout()">Cerrar sesión</button>
        </div>
      </div>
    </div>
  </header>

  <!-- FORMULARIO -->
  <main>
    <form id="frmSolicitud" novalidate>
      <div class="form-grid">

        <!-- NOMBRE -->
        <div class="row">
          <label for="nombre">Nombre completo</label>
          <input id="nombre" class="input" type="text" placeholder="Nombre completo" required />
        </div>

        <!-- RUT -->
        <div class="row">
          <label for="rut">RUT</label>
          <input id="rut" class="input" type="text" placeholder="Ej: 12.345.678-9" inputmode="text" autocomplete="off" required />
        </div>

        <!-- DIRECCIÓN -->
        <div class="row">
          <label for="direccion">Dirección</label>
          <input id="direccion" class="input" type="text" placeholder="Calle y número, comuna – Región Metropolitana" required />
        </div>

        <!-- TELÉFONO + RSH -->
        <div class="row cols">
          <div>
            <label for="telefono">Teléfono móvil</label>
            <input id="telefono" class="input" type="text" inputmode="numeric" placeholder="569XXXXXXXX" required />
            <div class="hint">Formato obligatorio: 569XXXXXXXX</div>
          </div>
          <div>
            <label for="rsh">% Registro social de hogares</label>
            <select id="rsh" class="select" required>
              <option value="" selected disabled>Selecciona…</option>
              <option>40%</option><option>50%</option><option>60%</option>
              <option>70%</option><option>80%</option><option>90%</option><option>100%</option>
            </select>
          </div>
        </div>

        <!-- TIPO(S) DE SOLICITUD -->
        <div class="row">
          <label>Indique su solicitud</label>
          <div class="checks">
            <label><input type="checkbox" name="tipos" value="Poda" /> Poda</label>
            <label><input type="checkbox" name="tipos" value="Cachureos" /> Cachureos</label>
            <label><input type="checkbox" name="tipos" value="Escombros" /> Escombros</label>
            <label><input type="checkbox" id="chkOtros" name="tipos" value="Otros" /> Otros</label>
            <input id="otrosDetalle" class="input" type="text" placeholder="Especifica otros…" style="display:none; min-width:280px;" />
          </div>
        </div>

        <!-- DETALLE -->
        <div class="row">
          <label for="detalle">Detalle de solicitud</label>
          <textarea id="detalle" class="textarea" rows="4" maxlength="600" placeholder="Describe la situación (máx. 600 caracteres)…"></textarea>
          <div class="counter"><span id="cnt">0</span>/600</div>
        </div>

        <!-- ARCHIVOS -->
        <div class="row cols">
          <div>
            <label for="fotoLugar">Adjuntar fotografía del lugar</label>
            <input id="fotoLugar" class="input" type="file" accept="image/png" />
            <span class="file-note">Solo PNG (hasta 5MB).</span>
          </div>
          <div>
            <label for="cartolaRSH">Adjuntar cartola registro social de hogares</label>
            <input id="cartolaRSH" class="input" type="file" accept="application/pdf" />
            <span class="file-note">Solo PDF (máximo 5 MB).</span>
          </div>
        </div>

        <!-- ERRORES -->
        <div id="msgError" class="error"></div>

        <!-- BOTONES -->
        <div class="actions">
          <button type="button" class="btn btn-cancel" id="btnCancel">Cancelar</button>
          <button type="submit" class="btn btn-ok" id="btnOk">Confirmar solicitud</button>
        </div>

      </div>
    </form>
  </main>

  <script>
    /* ======== Header: email/menú ======== */
    function getEmailFromClient(){
      const ls = (localStorage.getItem('email') || '').trim();
      if (ls) return ls;
      const ss = (sessionStorage.getItem('email') || '').trim();
      if (ss) return ss;
      const qs = new URLSearchParams(location.search).get('email');
      if (qs && qs.trim()) return decodeURIComponent(qs.trim());
      try {
        const userRaw = localStorage.getItem('user');
        if (userRaw) {
          const u = JSON.parse(userRaw);
          if (u && u.correo) return String(u.correo).trim();
        }
      } catch(e){}
      return '';
    }
    (function(){
      document.getElementById('emailFull').textContent = getEmailFromClient() || '—';
    })();
    const btn = document.getElementById('userBtn');
    const menu = document.getElementById('userMenu');
    btn.addEventListener('click', (e)=>{ e.stopPropagation(); const open = menu.classList.toggle('open'); btn.setAttribute('aria-expanded', open ? 'true' : 'false'); });
    document.addEventListener('click', ()=> menu.classList.remove('open'));
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') menu.classList.remove('open'); });
    function logout(){
      localStorage.removeItem('email'); sessionStorage.removeItem('email'); localStorage.removeItem('user');
      location.href = 'index.html';
    }

    /* ======== RUT formato X.XXX.XXX-X o XX.XXX.XXX-X ======== */
    const rutInput = document.getElementById('rut');
    rutInput.addEventListener('input', () => {
      let v = rutInput.value.replace(/[^0-9kK]/g, '').toUpperCase(); // números + K
      if (!v) { rutInput.value = ''; return; }
      const dv = v.slice(-1);
      let cuerpo = v.slice(0, -1);
      cuerpo = cuerpo.replace(/\B(?=(\d{3})+(?!\d))/g, '.'); // miles
      rutInput.value = `${cuerpo}-${dv}`;
    });

    /* ======== Teléfono: 569 + 8 dígitos exactos ======== */
    const tel = document.getElementById('telefono');
    // iniciar con 569 si está vacío
    if (!tel.value) tel.value = '569';
    function sanitizePhone(){
      // conservar solo dígitos y asegurar prefijo 569
      let raw = tel.value.replace(/\D/g,'');
      if (!raw.startsWith('569')) raw = '569' + raw.replace(/^569/,''); // fuerza prefijo
      // limitar a 11 caracteres totales (569 + 8)
      raw = raw.slice(0, 11);
      tel.value = raw;
    }
    tel.addEventListener('input', sanitizePhone);
    tel.addEventListener('focus', () => { if (!tel.value) tel.value = '569'; });
    tel.addEventListener('blur', () => {
      sanitizePhone();
      const ok = /^569\d{8}$/.test(tel.value);
      if (!ok) showError('El teléfono debe tener el formato 569XXXXXXXX');
    });

    /* ======== Otros / contador detalle ======== */
    const otrosChk = document.getElementById('chkOtros');
    const otrosInput = document.getElementById('otrosDetalle');
    otrosChk.addEventListener('change', () => {
      otrosInput.style.display = otrosChk.checked ? 'block' : 'none';
      if (!otrosChk.checked) otrosInput.value = '';
    });

    const detalle = document.getElementById('detalle');
    const cnt = document.getElementById('cnt');
    function updateCounter(){ cnt.textContent = String(detalle.value.length); }
    detalle.addEventListener('input', updateCounter);
    detalle.addEventListener('keyup', updateCounter);
    updateCounter();

    /* ======== Archivos: PNG único (<=5MB) y PDF (<=5MB) ======== */
    const foto = document.getElementById('fotoLugar');
    foto.addEventListener('change', () => {
      const f = foto.files[0];
      if (!f) return;
      if (f.type !== 'image/png') { foto.value = ''; return showError('La fotografía debe ser PNG'); }
      if (f.size > 5 * 1024 * 1024) { foto.value = ''; return showError('La fotografía no puede superar 5 MB'); }
    });
    const pdf = document.getElementById('cartolaRSH');
    pdf.addEventListener('change', () => {
      const f = pdf.files[0];
      if (!f) return;
      if (f.type !== 'application/pdf') { pdf.value = ''; return showError('La cartola debe ser PDF'); }
      if (f.size > 5 * 1024 * 1024) { pdf.value = ''; return showError('El PDF no puede superar 5 MB'); }
    });

    /* ======== Errores ======== */
    const msgError = document.getElementById('msgError');
    function showError(t){ msgError.textContent = t; msgError.classList.add('show'); setTimeout(()=>msgError.classList.remove('show'), 4000); }

    /* ======== Envío ======== */
    document.getElementById('frmSolicitud').addEventListener('submit', (e) => {
      e.preventDefault();
      if (!document.getElementById('nombre').value.trim()) return showError('Ingresa tu nombre completo');
      if (!rutInput.value.trim().includes('-')) return showError('Ingresa un RUT válido (con dígito verificador)');
      if (!document.getElementById('direccion').value.trim()) return showError('Ingresa tu dirección');
      if (!/^569\d{8}$/.test(tel.value.trim())) return showError('El teléfono debe tener el formato 569XXXXXXXX');
      if (!document.getElementById('rsh').value) return showError('Selecciona tu porcentaje RSH');
      alert('✅ Solicitud lista para enviar.\nCuando tengamos endpoint, subimos los archivos y guardamos en la DB.');
    });

    /* ======== Cancelar: vuelve a verify.html, preservando email si existe ======== */
    document.getElementById('btnCancel').addEventListener('click', () => {
      const email = getEmailFromClient();
      const dest = email ? ('verify.html?email=' + encodeURIComponent(email)) : 'verify.html';
      location.href = dest;
    });
  </script>
</body>
</html>
